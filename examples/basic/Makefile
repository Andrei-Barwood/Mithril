# ============================================================================
# Mithril Network Layer - Makefile
# ============================================================================
# Compilaci√≥n de ejemplos con libsodium + Boost.Asio
# ============================================================================

# Compiler configuration
CXX := clang++
CXXFLAGS := -std=c++20 -Wall -Wextra -O2
INCLUDES := -I/opt/homebrew/include -I/usr/local/include
LDFLAGS := -L/opt/homebrew/lib -L/usr/local/lib
LIBS := -lboost_system -lboost_context -lsodium -pthread

# Targets
SERVER := accepting_connection_sodium
CLIENT := secure_client

.PHONY: all clean run-server run-client test help

all: $(SERVER) $(CLIENT)

# ============================================================================
# Build Targets
# ============================================================================

$(SERVER): accepting_connection_sodium.cpp
	@echo "üî® Compiling server..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) $< $(LDFLAGS) $(LIBS) -o $@
	@echo "‚úÖ Server compiled: ./$(SERVER)"

$(CLIENT): secure_client.cpp
	@echo "üî® Compiling client..."
	$(CXX) $(CXXFLAGS) $(INCLUDES) $< $(LDFLAGS) $(LIBS) -o $@
	@echo "‚úÖ Client compiled: ./$(CLIENT)"

# ============================================================================
# Run Targets
# ============================================================================

run-server: $(SERVER)
	@echo ""
	@echo "üöÄ Starting Mithril secure server..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	./$(SERVER)

run-client: $(CLIENT)
	@echo ""
	@echo "üöÄ Starting Mithril secure client..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	./$(CLIENT) localhost 3333

# ============================================================================
# Testing
# ============================================================================

test: all
	@echo ""
	@echo "üß™ Running integration test..."
	@echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
	@echo ""
	@echo "Starting server in background..."
	@./$(SERVER) & SERVER_PID=$$!; \
	sleep 2; \
	echo "Running client..."; \
	./$(CLIENT) localhost 3333; \
	CLIENT_EXIT=$$?; \
	echo ""; \
	echo "Stopping server..."; \
	kill $$SERVER_PID 2>/dev/null || true; \
	if [ $$CLIENT_EXIT -eq 0 ]; then \
		echo "‚úÖ Test passed!"; \
	else \
		echo "‚ùå Test failed!"; \
		exit 1; \
	fi

# ============================================================================
# Cleanup
# ============================================================================

clean:
	@echo "üßπ Cleaning build artifacts..."
	rm -f $(SERVER) $(CLIENT)
	rm -f *.o *.dSYM
	@echo "‚úÖ Clean complete"

# ============================================================================
# Help
# ============================================================================

help:
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë          Mithril Network Layer - Build System             ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "Available targets:"
	@echo ""
	@echo "  make              Build both server and client"
	@echo "  make server       Build server only"
	@echo "  make client       Build client only"
	@echo "  make run-server   Build and run server"
	@echo "  make run-client   Build and run client (localhost:3333)"
	@echo "  make test         Run integration test"
	@echo "  make clean        Remove build artifacts"
	@echo "  make help         Show this help message"
	@echo ""
	@echo "Dependencies:"
	@echo "  - C++20 compiler (clang++ or g++)"
	@echo "  - Boost >= 1.82"
	@echo "  - libsodium"
	@echo ""
	@echo "Installation (macOS):"
	@echo "  brew install boost libsodium"
	@echo ""
	@echo "Installation (Ubuntu/Debian):"
	@echo "  sudo apt install libboost-all-dev libsodium-dev"
	@echo ""
	@echo "Usage example:"
	@echo "  Terminal 1: make run-server"
	@echo "  Terminal 2: make run-client"
	@echo ""

# ============================================================================
# Platform-specific adjustments
# ============================================================================

# Linux
ifeq ($(shell uname -s),Linux)
    INCLUDES := -I/usr/include
    LDFLAGS := -L/usr/lib
endif

# Check dependencies
check-deps:
	@echo "üîç Checking dependencies..."
	@command -v $(CXX) >/dev/null 2>&1 || { echo "‚ùå $(CXX) not found"; exit 1; }
	@pkg-config --exists libsodium 2>/dev/null || { echo "‚ö†Ô∏è  libsodium not found via pkg-config"; }
	@echo "‚úÖ Basic dependencies OK"

.PHONY: check-deps

# ============================================================================
# Installation targets
# ============================================================================

install-deps-macos:
	@echo "üì¶ Installing dependencies on macOS..."
	brew install boost libsodium

install-deps-ubuntu:
	@echo "üì¶ Installing dependencies on Ubuntu/Debian..."
	sudo apt update
	sudo apt install -y build-essential libboost-all-dev libsodium-dev

.PHONY: install-deps-macos install-deps-ubuntu
